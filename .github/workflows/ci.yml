name: CI

on: push

env:
  CBT_BACKEND: docker
  RUST_BACKTRACE: full
  RUST_LOG: debug

jobs:
  build:
    strategy:
      matrix:
        os:
        - cargo_build_target: aarch64-apple-darwin
          version: macos-15
        - cargo_build_target: aarch64-unknown-linux-musl
          version: ubuntu-24.04-arm
        - cargo_build_target: aarch64-unknown-linux-gnu
          version: ubuntu-24.04-arm
        - cargo_build_target: x86_64-unknown-linux-musl
          version: ubuntu-24.04
        - cargo_build_target: x86_64-unknown-linux-gnu
          version: ubuntu-24.04
    name: Build (${{ matrix.os.cargo_build_target }})
    runs-on: ${{ matrix.os.version }}
    env:
      CARGO_BUILD_TARGET: ${{ matrix.os.cargo_build_target }}
    steps:
    - if: ${{ endsWith(matrix.os.cargo_build_target, '-musl') }}
      run: sudo apt-get install --yes musl-tools
    - if: ${{ startsWith(matrix.os.version, 'ubuntu-') }}
      run: sudo apt-get install --yes postgresql-client
    - uses: actions/checkout@v4
    - uses: actions/cache@v4
      with:
        path: |
          target/
          ~/.cargo/bin/
          ~/.cargo/git/db/
          ~/.cargo/registry/cache/
          ~/.cargo/registry/index/
          ~/.rustup
        key: ${{ matrix.os.version }}-build-${{ matrix.os.cargo_build_target }}-${{ hashFiles('.github/workflows/ci.yml', '**/Cargo.lock', 'rust-toolchain.toml') }}

    - name: Run fmt
      run: cargo fmt --check

    - name: Build all targets
      run: cargo build --all-targets --release

    - name: Run clippy
      run: cargo clippy --release

    - name: Run tests
      run: |
        cargo test --release
        # Podman on GH actions is old <5.x cannot deal corectly with concurrent access to overlay storage.
        CBT_BACKEND=podman cargo test --release --package cbt -- --test-threads=1

    - name: Set up Ruby 3.4 for macOS gem build
      if: ${{ endsWith(matrix.os.cargo_build_target, '-darwin') }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'

    - name: Build integrations
      if: ${{ endsWith(matrix.os.cargo_build_target, '-musl') || endsWith(matrix.os.cargo_build_target, '-darwin') }}
      run: cargo run --release --package manager -- integrations build

    - name: Upload build artifacts
      if: ${{ !endsWith(matrix.os.cargo_build_target, '-gnu') }}
      uses: actions/upload-artifact@v4
      with:
        name: pg-ephemeral-${{ matrix.os.cargo_build_target }}
        path: |
          dist/
          target/${{ matrix.os.cargo_build_target }}/release/manager
        retention-days: 7

  ruby-integration-test:
    strategy:
      matrix:
        platform:
        - runner: ubuntu-24.04
          target: x86_64-unknown-linux-musl
        - runner: ubuntu-24.04-arm
          target: aarch64-unknown-linux-musl
        - runner: macos-15
          target: aarch64-apple-darwin
        ruby-version:
        - '3.2'
        - '3.3'
        - '3.4'
    name: Ruby Integration Test (${{ matrix.platform.runner }}, Ruby ${{ matrix.ruby-version }})
    runs-on: ${{ matrix.platform.runner }}
    needs: build
    steps:
    - uses: actions/checkout@v4

    - name: Install libpq-dev on Ubuntu
      if: ${{ startsWith(matrix.platform.runner, 'ubuntu-') }}
      run: sudo apt-get update && sudo apt-get install --yes libpq-dev

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        merge-multiple: false

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}

    - name: Make manager executable
      run: chmod +x artifacts/pg-ephemeral-${{ matrix.platform.target }}/target/${{ matrix.platform.target }}/release/manager

    - name: Merge multi-platform gems
      run: artifacts/pg-ephemeral-${{ matrix.platform.target }}/target/${{ matrix.platform.target }}/release/manager integrations merge-gems

    - name: Run integration tests with manager
      run: artifacts/pg-ephemeral-${{ matrix.platform.target }}/target/${{ matrix.platform.target }}/release/manager integrations test

  publish:
    name: Publish Edge Build
    needs:
    - build
    - ruby-integration-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create edge build release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        chmod +x artifacts/pg-ephemeral-x86_64-unknown-linux-musl/target/x86_64-unknown-linux-musl/release/manager
        artifacts/pg-ephemeral-x86_64-unknown-linux-musl/target/x86_64-unknown-linux-musl/release/manager release create-edge
