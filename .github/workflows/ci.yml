name: CI

on: push

env:
  OCIMAN_BACKEND: docker
  RUST_BACKTRACE: full
  RUST_LOG: debug

jobs:
  build:
    strategy:
      matrix:
        os:
        - cargo_build_target: aarch64-apple-darwin
          version: macos-15
        - cargo_build_target: aarch64-unknown-linux-musl
          version: ubuntu-24.04-arm
        - cargo_build_target: aarch64-unknown-linux-gnu
          version: ubuntu-24.04-arm
        - cargo_build_target: x86_64-unknown-linux-musl
          version: ubuntu-24.04
        - cargo_build_target: x86_64-unknown-linux-gnu
          version: ubuntu-24.04
    name: Build (${{ matrix.os.cargo_build_target }})
    runs-on: ${{ matrix.os.version }}
    env:
      CARGO_BUILD_TARGET: ${{ matrix.os.cargo_build_target }}
    steps:
    - if: ${{ endsWith(matrix.os.cargo_build_target, '-musl') }}
      run: sudo apt-get update && sudo apt-get install --yes musl-tools
    - if: ${{ startsWith(matrix.os.version, 'ubuntu-') }}
      run: sudo apt-get update && sudo apt-get install --yes postgresql-client git-restore-mtime
    - if: ${{ startsWith(matrix.os.version, 'macos-') }}
      run: brew install git-tools
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0
    - run: git restore-mtime
    - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: |
          target/
          ~/.cargo/bin/
          ~/.cargo/git/db/
          ~/.cargo/registry/cache/
          ~/.cargo/registry/index/
          ~/.rustup
        key: ${{ matrix.os.version }}-build-${{ matrix.os.cargo_build_target }}-${{ hashFiles('.github/workflows/ci.yml', '**/Cargo.lock', 'rust-toolchain.toml') }}

    - name: Run fmt
      run: cargo --verbose fmt --check

    - name: Build all targets
      run: cargo --verbose build --all-targets --all-features --release

    - name: Check for dirty repository
      run: git diff --exit-code

    - name: Run repository lint
      run: target/${{ matrix.os.cargo_build_target }}/release/manager repository-lint rust-version

    - name: Verify stratosphere generated code is committed
      run: |
        target/${{ matrix.os.cargo_build_target }}/release/manager stratosphere sync --reject-dirty
        git restore-mtime

    - name: Run clippy
      run: cargo --verbose clippy --all-features --all-targets --release

    - name: Install nextest
      uses: taiki-e/install-action@650c5ca14212efbbf3e580844b04bdccf68dac31 # v2.67.18
      with:
        tool: cargo-nextest

    - name: Run tests
      run: |
        cargo --verbose nextest run --all-features --release
        # Podman on GH actions is old <5.x cannot deal corectly with concurrent access to overlay storage.
        OCIMAN_BACKEND=podman cargo --verbose nextest run --all-features --release --package ociman --test-threads=1

    # nextest does not support doctests, run them separately.
    - name: Run doctests
      run: cargo --verbose test --doc --all-features --release

    - name: Set up Ruby 3.4 for macOS gem build
      if: ${{ endsWith(matrix.os.cargo_build_target, '-darwin') }}
      uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1.288.0
      with:
        ruby-version: '3.4'

    - name: Verify pg-ephemeral generated files are committed
      run: target/${{ matrix.os.cargo_build_target }}/release/manager pg-ephemeral sync --reject-dirty

    - name: Build pg-ephemeral gem
      if: ${{ endsWith(matrix.os.cargo_build_target, '-musl') || endsWith(matrix.os.cargo_build_target, '-darwin') }}
      run: target/${{ matrix.os.cargo_build_target }}/release/manager pg-ephemeral build --no-compile

    - name: Upload build artifacts
      if: ${{ !endsWith(matrix.os.cargo_build_target, '-gnu') }}
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: pg-ephemeral-${{ matrix.os.cargo_build_target }}
        path: |
          dist/
          target/${{ matrix.os.cargo_build_target }}/release/manager
        retention-days: 7

  ruby-integration-test:
    # Workaround for Bundler 4.x failing when attempting to install gems to the
    # system path on GitHub Actions Ubuntu runners. The runner's gem directory is
    # world-writable without the sticky bit, triggering Bundler's security check.
    # See: https://github.com/ruby/rubygems/issues/7983
    env:
      BUNDLE_PATH: vendor/bundle
    strategy:
      matrix:
        platform:
        - runner: ubuntu-24.04
          target: x86_64-unknown-linux-musl
        - runner: ubuntu-24.04-arm
          target: aarch64-unknown-linux-musl
        - runner: macos-15
          target: aarch64-apple-darwin
        ruby-version:
        - '3.2'
        - '3.3'
        - '3.4'
        - '4.0'
    name: Ruby Integration Test (${{ matrix.platform.runner }}, Ruby ${{ matrix.ruby-version }})
    runs-on: ${{ matrix.platform.runner }}
    needs: build
    steps:
    - if: ${{ startsWith(matrix.platform.runner, 'ubuntu-') }}
      run: sudo apt-get update && sudo apt-get install --yes git-restore-mtime
    - if: ${{ startsWith(matrix.platform.runner, 'macos-') }}
      run: brew install git-tools
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0
    - run: git restore-mtime

    - name: Install libpq-dev on Ubuntu
      if: ${{ startsWith(matrix.platform.runner, 'ubuntu-') }}
      run: sudo apt-get update && sudo apt-get install --yes libpq-dev

    - name: Download all artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        path: artifacts/
        merge-multiple: false

    - name: Set up Ruby
      uses: ruby/setup-ruby@09a7688d3b55cf0e976497ff046b70949eeaccfd # v1.288.0
      with:
        ruby-version: ${{ matrix.ruby-version }}

    - name: Make manager executable
      run: chmod +x artifacts/pg-ephemeral-${{ matrix.platform.target }}/target/${{ matrix.platform.target }}/release/manager

    - name: Merge multi-platform gems
      run: artifacts/pg-ephemeral-${{ matrix.platform.target }}/target/${{ matrix.platform.target }}/release/manager pg-ephemeral merge-gems

    - name: Run integration tests with manager
      run: artifacts/pg-ephemeral-${{ matrix.platform.target }}/target/${{ matrix.platform.target }}/release/manager pg-ephemeral test

  publish:
    name: Publish Edge Build
    needs:
    - build
    - ruby-integration-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - run: sudo apt-get update && sudo apt-get install --yes git-restore-mtime
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0
    - run: git restore-mtime

    - name: Download all artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        path: artifacts

    - name: Create edge build release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        chmod +x artifacts/pg-ephemeral-x86_64-unknown-linux-musl/target/x86_64-unknown-linux-musl/release/manager
        artifacts/pg-ephemeral-x86_64-unknown-linux-musl/target/x86_64-unknown-linux-musl/release/manager release create-edge
