name: CI

on: push

env:
  RUSTFLAGS: --deny=warnings

jobs:
  test:
    strategy:
      matrix:
        os:
        - cargo_build_target: aarch64-apple-darwin
          version: macos-15
        - cargo_build_target: aarch64-unknown-linux-musl
          version: ubuntu-24.04-arm
        - cargo_build_target: aarch64-unknown-linux-gnu
          version: ubuntu-24.04-arm
        - cargo_build_target: x86_64-unknown-linux-musl
          version: ubuntu-24.04
        - cargo_build_target: x86_64-unknown-linux-gnu
          version: ubuntu-24.04
    name: Test (${{ matrix.os.cargo_build_target }})
    runs-on: ${{ matrix.os.version }}
    env:
      CARGO_BUILD_TARGET: ${{ matrix.os.cargo_build_target }}
    steps:
    - if: ${{ endsWith(matrix.os.cargo_build_target, '-musl') }}
      run: sudo apt-get install --yes musl-tools
    - uses: actions/checkout@v4
    - uses: actions/cache@v4
      with:
        path: |
          target/
          ~/.cargo/bin/
          ~/.cargo/git/db/
          ~/.cargo/registry/cache/
          ~/.cargo/registry/index/
          ~/.rustup
        key: ${{ matrix.os.version }}-build-${{ matrix.os.cargo_build_target }}-${{ hashFiles('.github/workflows/ci.yml', '**/Cargo.lock', 'rust-toolchain.toml') }}

    - name: Run fmt
      run: cargo fmt --check

    - name: Run clippy
      run: cargo clippy --release

    - name: Run tests
      run: cargo test --release

    - name: Package release binary
      if: ${{ !endsWith(matrix.os.cargo_build_target, '-gnu') }}
      run: |
        cd target/${{ matrix.os.cargo_build_target }}/release
        tar czf pg-ephemeral-${{ matrix.os.cargo_build_target }}.tar.gz pg-ephemeral
        sha256sum pg-ephemeral-${{ matrix.os.cargo_build_target }}.tar.gz > pg-ephemeral-${{ matrix.os.cargo_build_target }}.tar.gz.sha256

    - name: Upload build artifacts
      if: ${{ !endsWith(matrix.os.cargo_build_target, '-gnu') }}
      uses: actions/upload-artifact@v4
      with:
        name: pg-ephemeral-${{ matrix.os.cargo_build_target }}
        path: |
          target/${{ matrix.os.cargo_build_target }}/release/pg-ephemeral-${{ matrix.os.cargo_build_target }}.tar.gz
          target/${{ matrix.os.cargo_build_target }}/release/pg-ephemeral-${{ matrix.os.cargo_build_target }}.tar.gz.sha256
        retention-days: 7

  publish:
    name: Publish Edge Build
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create edge build release and upload all binaries
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="edge-${{ github.sha }}"
        RELEASE_NAME="Edge Build (${{ github.ref_name }} @ ${{ github.sha }})"

        # Collect all artifact files
        FILES=$(find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \))

        # Create prerelease with all artifacts
        gh release create "$TAG" \
          --prerelease \
          --title "$RELEASE_NAME" \
          --notes "Automated edge build from commit ${{ github.sha }}" \
          $FILES
